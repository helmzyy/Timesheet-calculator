<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Time & Pay Calculator</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header class="brand">
        <h1>Time &amp; Pay</h1>
        <div class="stamp" id="stamp"></div>
      </header>

      <section class="panel">
        <h2>Pay &amp; Withholdings</h2>
        <div class="field">
          <label for="rate">Hourly Rate ($/hr)</label>
          <input id="rate" type="number" step="0.01" value="25">
        </div>

        <div class="grid two">
          <div class="field">
            <label for="fed">Federal Tax (%)</label>
            <input id="fed" type="number" step="0.01" value="12">
          </div>
          <div class="field">
            <label for="ss">Social Security (%)</label>
            <input id="ss" type="number" step="0.01" value="6.2">
          </div>
          <div class="field">
            <label for="med">Medicare (%)</label>
            <input id="med" type="number" step="0.01" value="1.45">
          </div>
          <div class="field">
            <label for="health">Healthcare ($)</label>
            <input id="health" type="number" step="0.01" value="0">
          </div>
          <div class="field">
            <label for="misc">Misc Withholding ($)</label>
            <input id="misc" type="number" step="0.01" value="0">
          </div>
        </div>

        <div class="actions">
          <button id="calc" class="primary">Calculate</button>
          <button id="clearInput">Clear Input</button>
          <button id="copyOut">Copy Result</button>
          <button id="csv">Download CSV</button>
        </div>
      </section>

      <section class="panel small-note">
        <h3>Input Format</h3>
        <p>One line per shift:</p>
        <pre class="code">8/27/25 5:00am-9:00pm 30 min lunch
8/28/25 6:15am-6:30pm no lunch
9/1/25 Labor Day</pre>
        <p>AM/PM required. Overnight shifts are supported.</p>
      </section>
    </aside>

    <main class="main">
      <section class="panel">
        <h2>Paste Hours</h2>
        <textarea id="input" placeholder="Paste hours here..."></textarea>
      </section>

      <section class="panel">
        <h2>Results</h2>
        <div id="cards"></div>
        <pre id="output" class="mono"></pre>
      </section>

      <section class="panel">
        <div class="header-row">
          <h2>History</h2>
          <button id="clearHistory" class="ghost">Clear History</button>
        </div>
        <div class="table-wrap">
          <table class="table" id="history">
            <thead>
              <tr>
                <th>Range</th>
                <th>Total Hours</th>
                <th>Rate</th>
                <th>Gross</th>
                <th>Net (est.)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="histBody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const stamp = $('#stamp');
  const input = $('#input');
  const cards = $('#cards');
  const output = $('#output');
  const btnCalc = $('#calc');
  const btnClearInput = $('#clearInput');
  const btnCopy = $('#copyOut');
  const btnCSV = $('#csv');
  const btnClearHistory = $('#clearHistory');

  // Sidebar inputs
  const rateEl = $('#rate');
  const fedEl = $('#fed');
  const ssEl = $('#ss');
  const medEl = $('#med');
  const healthEl = $('#health');
  const miscEl = $('#misc');

  const LS_KEY = 'timepay.history.v2';

  function nowStamp(){
    const d = new Date();
    stamp.textContent = d.toLocaleString();
  }
  nowStamp();

  function parseLine(line){
    // Returns {ok, minutes, date, raw, note}
    const raw = line.trim();
    if(!raw) return null;

    // Off / holiday
    if(/labor day|holiday|off/i.test(raw)){
      // Try to grab date if present
      const dateTok = raw.split(/\s+/)[0];
      const dt = parseDateToken(dateTok);
      return {ok:true, minutes:0, date:dt, raw, note:'Holiday/Off'};
    }

    // Basic: DATE START-END ... lunch
    const dateTok = raw.split(/\s+/)[0];
    const dt = parseDateToken(dateTok);

    const timeMatch = raw.match(/(\d{1,2}:\d{2}\s*[ap]m)\s*-\s*(\d{1,2}:\d{2}\s*[ap]m)/i);
    if(!timeMatch){
      return {ok:false, minutes:0, date:dt, raw, note:'Unrecognized'};
    }
    const startStr = timeMatch[1].replace(/\s+/g,'').toLowerCase();
    const endStr = timeMatch[2].replace(/\s+/g,'').toLowerCase();

    // Lunch deduction
    let lunchMin = 0;
    const lunchMinMatch = raw.match(/(\d+)\s*(?:min|minutes)\s*lunch/i);
    if(lunchMinMatch) {
      lunchMin = parseInt(lunchMinMatch[1],10);
    } else if(/no\s*lunch/i.test(raw)) {
      lunchMin = 0;
    } else {
      const hrMatch = raw.match(/(\d+)\s*(?:hr|hour|hours)\s*lunch/i);
      if(hrMatch) lunchMin = parseInt(hrMatch[1],10)*60;
    }

    if(!dt){ return {ok:false, minutes:0, date:null, raw, note:'Bad date'}; }

    const start = toDateTime(dt.y, dt.m, dt.d, startStr);
    let end = toDateTime(dt.y, dt.m, dt.d, endStr);
    if(end <= start){ end = new Date(end.getTime() + 24*60*60*1000); }

    const mins = Math.max(0, Math.round((end - start)/60000) - lunchMin);
    return {ok:true, minutes:mins, date:dt, raw, note:''};
  }

  function parseDateToken(tok){
    const parts = tok.split(/[\/\-\.]/);
    if(parts.length < 2) return null;
    let m = parseInt(parts[0],10);
    let d = parseInt(parts[1],10);
    let y = (parts.length >= 3) ? parseInt(parts[2],10) : (new Date().getFullYear());
    if(y < 100) y += 2000;
    if(!(m>=1 && m<=12 && d>=1 && d<=31)) return null;
    return {y,m,d};
  }

  function toDateTime(y,m,d,hhmmAP){
    const t = hhmmAP.match(/(\d{1,2}):(\d{2})(am|pm)/i);
    let hh = parseInt(t[1],10), mm = parseInt(t[2],10);
    const ap = t[3].toLowerCase();
    if(hh===12){ hh = (ap==='am') ? 0 : 12; } else if(ap==='pm'){ hh += 12; }
    return new Date(y, m-1, d, hh, mm, 0, 0);
  }

  function fmtHM(mins){
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  }

  function fmtCurrency(n){
    return '$' + (Math.round(n*100)/100).toFixed(2);
  }

  function rangeLabel(dates){
    // dates: array of {y,m,d} (some may be null)
    const valid = dates.filter(Boolean);
    if(!valid.length) return '—';
    valid.sort((a,b)=>new Date(a.y,a.m-1,a.d) - new Date(b.y,b.m-1,b.d));
    const first = valid[0], last = valid[valid.length-1];
    function short(dt){
      return `${dt.m}/${dt.d}${(first.y!==last.y)?('/'+String(dt.y).slice(-2)):''}`;
    }
    // If same month/year show M/D–D, else M/D–M/D (and include year if different)
    if(first.y===last.y && first.m===last.m){
      return `${first.m}/${first.d}–${last.d}`;
    } else {
      return `${short(first)}–${short(last)}`;
    }
  }

  function grossFromMinutes(mins, rate){
    const hrs = mins/60;
    const reg = Math.min(hrs, 40);
    const ot = Math.max(0, hrs - 40);
    return reg*rate + ot*rate*1.5;
  }

  function netFromGross(gross, perc, health, misc){
    // perc is sum of percent values (e.g., 12 + 6.2 + 1.45)
    const pct = (isFinite(perc)?perc:0)/100;
    const fixed = (isFinite(health)?health:0) + (isFinite(misc)?misc:0);
    return Math.max(0, gross*(1 - pct) - fixed);
  }

  function renderCards(rows, totalMin, rate, gross, net){
    cards.innerHTML = '';
    // Daily card list
    rows.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card';
      const note = r.note ? ` <span class="muted">(${r.note})</span>` : '';
      card.innerHTML = `<div class="card-row"><div>${r.raw}</div><div class="pill">${fmtHM(r.minutes)}</div></div>`;
      cards.appendChild(card);
    });

    // Totals
    const totals = document.createElement('div');
    totals.className = 'totals';
    totals.innerHTML = `
      <div class="total-line"><span>Total Time</span><strong>${fmtHM(totalMin)} (${(totalMin/60).toFixed(2)} hrs)</strong></div>
      <div class="total-line"><span>Gross</span><strong>${fmtCurrency(gross)} @ ${fmtCurrency(rate)}/hr</strong></div>
      <div class="total-line"><span>Net (est.)</span><strong>${fmtCurrency(net)}</strong></div>
    `;
    cards.appendChild(totals);
  }

  function saveHistory(entry){
    const list = loadHistory();
    list.push(entry);
    localStorage.setItem(LS_KEY, JSON.stringify(list));
  }

  function loadHistory(){
    try {
      const data = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      return Array.isArray(data) ? data : [];
    } catch(e){ return []; }
  }

  function deleteHistory(idx){
    const list = loadHistory();
    if(idx>=0 && idx<list.length){
      list.splice(idx,1);
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }
    renderHistory();
  }

  function clearHistory(){
    localStorage.removeItem(LS_KEY);
    renderHistory();
  }

  function renderHistory(){
    const tbody = $('#histBody');
    const list = loadHistory();
    tbody.innerHTML = '';
    list.forEach((e, i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.range}</td>
        <td>${e.totalHours.toFixed(2)}</td>
        <td>${fmtCurrency(e.rate)}</td>
        <td>${fmtCurrency(e.gross)}</td>
        <td>${fmtCurrency(e.net)}</td>
        <td class="right"><button class="danger small" data-del="${i}">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
    // Wire delete buttons
    $$('#histBody [data-del]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i = parseInt(e.currentTarget.getAttribute('data-del'),10);
        deleteHistory(i);
      });
    });
  }
  renderHistory();

  function calculate(){
    nowStamp();
    const lines = input.value.split(/\r?\n/).filter(s=>s.trim().length>0);
    let totalMin = 0;
    let rows = [];
    let dates = [];
    lines.forEach(ln => {
      const r = parseLine(ln);
      if(!r) return;
      rows.push(r);
      totalMin += (r.ok ? r.minutes : 0);
      if(r.date) dates.push(r.date);
    });

    const rate = parseFloat(rateEl.value)||0;
    const fed = parseFloat(fedEl.value)||0;
    const ss = parseFloat(ssEl.value)||0;
    const med = parseFloat(medEl.value)||0;
    const health = parseFloat(healthEl.value)||0;
    const misc = parseFloat(miscEl.value)||0;

    const gross = grossFromMinutes(totalMin, rate);
    const sumPct = fed + ss + med;
    const net = netFromGross(gross, sumPct, health, misc);

    renderCards(rows, totalMin, rate, gross, net);

    // Text output
    let text = '';
    rows.forEach(r => {
      text += `- ${r.raw} → ${fmtHM(r.minutes)}${r.note?(' ('+r.note+')'):''}\n`;
    });
    text += `\nTotal: ${fmtHM(totalMin)} (${(totalMin/60).toFixed(2)} hrs)\n`;
    text += `Gross: ${fmtCurrency(gross)} @ ${fmtCurrency(rate)}/hr\n`;
    text += `Net (est.): ${fmtCurrency(net)} [${sumPct.toFixed(2)}% + ${fmtCurrency(health)} + ${fmtCurrency(misc)}]\n`;
    output.textContent = text;

    // Save to history with date range
    const range = rangeLabel(dates);
    saveHistory({
      range,
      totalHours: totalMin/60,
      rate,
      gross,
      net,
      inputs: {fed, ss, med, health, misc},
      createdAt: new Date().toISOString()
    });
    renderHistory();
  }

  function downloadCSV(){
    const rows = output.textContent.trim().split('\n');
    let csv = 'Line,Value\n';
    rows.forEach(r=>{
      const safe = r.replace(/"/g,'""');
      csv += `"${safe}",\n`;
    });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'hours.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  btnCalc.addEventListener('click', calculate);
  btnClearInput.addEventListener('click', ()=>{ input.value=''; output.textContent=''; cards.innerHTML=''; });
  btnCopy.addEventListener('click', ()=> navigator.clipboard.writeText(output.textContent));
  btnCSV.addEventListener('click', downloadCSV);
  btnClearHistory.addEventListener('click', clearHistory);
})();
</script>
</body>
</html>
