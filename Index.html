<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Shift Hours Calculator</title>
  <style>
    body{font-family:system-ui,Arial;max-width:950px;margin:2rem auto;color:#111}
    h1{margin-bottom:.2rem}
    textarea{width:100%;height:200px;font-family:monospace;margin-bottom:.5rem;padding:.5rem}
    .row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem;flex-wrap:wrap}
    button{padding:.4rem .8rem}
    pre{background:#f7f7f7;padding:1rem;white-space:pre-wrap}
    .small{font-size:.9rem;color:#555}
    label{font-weight:600}
    table{border-collapse:collapse;width:100%;margin-top:1rem}
    th,td{border:1px solid #ccc;padding:.4rem;text-align:left;font-size:.9rem}
  </style>
</head>
<body>
  <h1>Shift Hours Calculator</h1>

  <div class="row">
    <label>Pay Rate $/hr: <input id="rate" type="number" value="25" step="0.01" style="width:6rem"></label>
    <div id="timestamp" class="small" style="margin-left:auto"></div>
  </div>

  <textarea id="input" placeholder="Paste hours here..."></textarea>

  <div class="row">
    <button id="calc">Calculate</button>
    <button id="clear">Clear</button>
    <button id="copy">Copy Result</button>
    <button id="download">Download CSV</button>
  </div>

  <pre id="output"></pre>

  <h2>History</h2>
  <table id="history"><thead>
    <tr><th>Date</th><th>Total Hours</th><th>Pay Rate</th><th>Gross Income</th></tr>
  </thead><tbody></tbody></table>

<script>
(function(){
  const input=document.getElementById('input');
  const output=document.getElementById('output');
  const calc=document.getElementById('calc');
  const clear=document.getElementById('clear');
  const copy=document.getElementById('copy');
  const download=document.getElementById('download');
  const rateInput=document.getElementById('rate');
  const historyTable=document.querySelector('#history tbody');
  const ts=document.getElementById('timestamp');

  function nowStamp(){
    const d=new Date();
    ts.textContent=d.toLocaleString();
  }
  nowStamp();

  function parseLine(line){
    line=line.trim(); if(!line) return null;
    if(/labor day|holiday|off/i.test(line)) return {dateLine:line,minutes:0,note:'Holiday/Off'};
    const timeMatch=line.match(/(\d{1,2}:\d{2}\s*[ap]m)\s*-\s*(\d{1,2}:\d{2}\s*[ap]m)/i);
    if(!timeMatch) return {dateLine:line,minutes:0,note:'Unrecognized'};
    const startRaw=timeMatch[1].replace(/\s+/g,'').toLowerCase();
    const endRaw=timeMatch[2].replace(/\s+/g,'').toLowerCase();
    let lunchMin=0;
    const lunchMatch=line.match(/(\d+)\s*(?:min|minutes)/i);
    if(lunchMatch) lunchMin=parseInt(lunchMatch[1],10);
    else if(/no lunch/i.test(line)) lunchMin=0;
    else {
      const hrMatch=line.match(/(\d+)\s*(?:hr|hour|hours)/i);
      if(hrMatch) lunchMin=parseInt(hrMatch[1],10)*60;
    }
    const datePart=line.split(/\s+/)[0];
    const dateParts=datePart.split(/[\/\-\.]/);
    let mo=parseInt(dateParts[0],10),da=parseInt(dateParts[1],10),yy=parseInt(dateParts[2],10);
    if(yy<100) yy+=2000;
    function to24(y,m,d,str){
      const t=str.match(/(\d{1,2}):(\d{2})(am|pm)/i);
      let hh=parseInt(t[1],10), mm=parseInt(t[2],10), ap=t[3].toLowerCase();
      if(hh===12){hh=(ap==='am'?0:12);} else if(ap==='pm'){hh+=12;}
      return new Date(y,m-1,d,hh,mm);
    }
    const start=to24(yy,mo,da,startRaw), end=to24(yy,mo,da,endRaw);
    let e=end; if(e<=start) e=new Date(e.getTime()+86400000);
    const mins=Math.max(0,Math.round((e-start)/60000)-lunchMin);
    return {dateLine:datePart,minutes:mins,note:''};
  }

  function formatHM(mins){
    const h=Math.floor(mins/60), m=mins%60;
    return `${h}:${String(m).padStart(2,'0')}`;
  }

  function calcGross(mins,rate){
    const hrs=mins/60;
    const reg=Math.min(hrs,40), ot=Math.max(0,hrs-40);
    return (reg*rate + ot*rate*1.5);
  }

  function saveHistory(date,totalHrs,rate,gross){
    let data=JSON.parse(localStorage.getItem('shiftHistory')||'[]');
    data.push({date,totalHrs,rate,gross});
    localStorage.setItem('shiftHistory',JSON.stringify(data));
    renderHistory();
  }

  function renderHistory(){
    const data=JSON.parse(localStorage.getItem('shiftHistory')||'[]');
    historyTable.innerHTML='';
    for(const row of data){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${row.date}</td><td>${row.totalHrs.toFixed(2)}</td>
        <td>$${row.rate.toFixed(2)}</td><td>$${row.gross.toFixed(2)}</td>`;
      historyTable.appendChild(tr);
    }
  }
  renderHistory();

  calc.addEventListener('click',()=>{
    nowStamp();
    const lines=input.value.split(/\r?\n/);
    let total=0; let out='';
    for(const ln of lines){
      if(!ln.trim()) continue;
      const r=parseLine(ln);
      total+=r.minutes;
      out+=`- ${r.dateLine}: ${ln} â†’ ${formatHM(r.minutes)}${r.note?(' ('+r.note+')'):''}\n`;
    }
    const rate=parseFloat(rateInput.value)||0;
    const gross=calcGross(total,rate);
    out+=`\nTotal: ${formatHM(total)} (${(total/60).toFixed(2)} hrs)\n`;
    out+=`Gross: $${gross.toFixed(2)} @ $${rate.toFixed(2)}/hr\n`;
    output.textContent=out;
    saveHistory(new Date().toLocaleDateString(), total/60, rate, gross);
  });

  clear.addEventListener('click',()=>{input.value='';output.textContent='';});
  copy.addEventListener('click',()=>navigator.clipboard.writeText(output.textContent));
  download.addEventListener('click',()=>{
    const csv='Date,Raw,Hrs\n'+output.textContent.replace(/\n/g,',\n');
    const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='hours.csv';a.click();URL.revokeObjectURL(url);
  });
})();
</script>
</body>
</html>